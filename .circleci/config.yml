version: 2.1

jobs:
  mvn_package:
    parameters:
      project:
        type: string

    docker:
      - image: circleci/openjdk:8-jdk

    working_directory: ~/instrumenting-java-for-prometheus/<< parameters.project >>

    steps:
    - checkout:
        path: ~/instrumenting-java-for-prometheus/
    - restore_cache:
        key: instrumenting-java-for-prometheus-<< parameters.project >>-{{ checksum "pom.xml" }}
    - run:
        command: mvn -B dependency:go-offline
    - save_cache:
        paths:
          - ~/.m2
        key: instrumenting-java-for-prometheus-<< parameters.project >>-{{ checksum "pom.xml" }}
    - run:
        command: mvn -B package
    - setup_remote_docker
    - run: docker build -t << parameters.project >>:latest .
    - run: docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD quay.io
    - run: docker tag << parameters.project >>:latest "quay.io/simonpasquier/<< parameters.project >>:latest"
    - run: docker push quay.io/simonpasquier/<< parameters.project >>

workflows:
  version: 2
  master:
    jobs:
    - mvn_package:
        name: client_java
        project: client_java
    - mvn_package:
        name: mp_metrics
        project: mp_metrics
